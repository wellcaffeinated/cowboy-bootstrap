---
- name: Install Vault
  ansible.builtin.apt:
    name: vault
    state: present
  notify:
    - restart-vault

- name: Create Vault data directory
  ansible.builtin.file:
    path: /opt/vault/data
    state: directory
    owner: vault
    group: vault
    mode: '0750'

- name: Create Vault config directory
  ansible.builtin.file:
    path: /etc/vault.d
    state: directory
    owner: vault
    group: vault
    mode: '0750'

- name: Deploy Vault server configuration
  ansible.builtin.template:
    src: vault-server.hcl.j2
    dest: /etc/vault.d/vault.hcl
    owner: vault
    group: vault
    mode: '0640'
  notify:
    - restart-vault

- name: Enable and start Vault service
  ansible.builtin.service:
    name: vault
    enabled: true
    state: started
  delegate_to: local-host
  become: true

# Note: Vault will self-register with Consul using service_registration
# No need for manual service definition that causes startup timing issues
