# dnsmasq - DHCP, DNS, and TFTP server for PXE boot
# Provides: DHCP (192.168.100.100-200), DNS forwarding, TFTP for iPXE bootloader

# Bind to bootstrap LAN interface only
interface=enx00e04c1b3a80
bind-interfaces
dhcp-no-override

# DHCP: Assign IPs with 12h lease, provide gateway and DNS
dhcp-range=192.168.100.100,192.168.100.200,12h
dhcp-option=option:router,192.168.100.1
dhcp-option=option:dns-server,192.168.100.1

# DNS: Forward queries to Cloudflare, don't use /etc/resolv.conf
no-resolv
server=1.1.1.1
server=1.0.0.1
domain-needed
bogus-priv

# PXE Boot: Two-stage chainload (TFTP → iPXE → HTTP → Shoelaces)
# Detect iPXE user-class to determine boot stage
dhcp-userclass=set:ipxe,iPXE

# ARM64 UEFI (Raspberry Pi 4+)
# Stage 1: Serve iPXE bootloader via TFTP (arch code 11 = ARM64_EFI)
dhcp-match=set:efi-arm64,option:client-arch,11
pxe-service=tag:efi-arm64,tag:#ipxe,ARM64_EFI,'Load iPXE',snponly_arm64.efi

# Stage 2: Send HTTP URL to Shoelaces for boot config
pxe-service=tag:efi-arm64,tag:ipxe,ARM64_EFI,'Boot',http://192.168.100.1:8081/start

# x86_64 UEFI (future NUC support - currently disabled)
# dhcp-match=set:efi-x86_64,option:client-arch,7
# pxe-service=tag:efi-x86_64,tag:#ipxe,X86-64_EFI,'Load iPXE',snponly.efi
# pxe-service=tag:efi-x86_64,tag:ipxe,X86-64_EFI,'Boot',http://192.168.100.1:8081/start

# TFTP: Serve files from /netboot/ipxe (mounted from host volume)
enable-tftp
tftp-root=/netboot/ipxe

# Logging
log-dhcp
log-queries
