# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Overview

This is an Ubuntu Server bootstrap system that uses Docker-based Ansible to configure a fresh Ubuntu installation. The system runs Ansible in a privileged Docker container that uses chroot to configure the host system.

## Running the Bootstrap

On a clean Ubuntu Server installation:

```bash
sudo ./begin.sh
```

This will:
1. Install Docker if not present
2. Generate an SSH key (`~/.ssh/id_ed25519_ansible`) if needed
3. Build the Ansible Docker image
4. Run the Ansible playbook via Docker with chroot connection

## Architecture

### Bootstrap Flow

The bootstrap process uses a unique architecture to avoid requiring Ansible on the host:

1. **begin.sh** - Entry point that:
   - Ensures root privileges
   - Installs Docker
   - Generates SSH keys for Ansible
   - Builds Docker image from `ansible/Dockerfile`
   - Runs Docker container with `--privileged` and `-v /:/host` to mount the host filesystem
   - Executes Ansible playbook with `-c community.general.chroot` to target the host

2. **Ansible Inventory** - Defines two connection methods:
   - `chroot` - Uses chroot connection to `/host` for initial setup
   - `host` - Uses SSH connection to localhost for service restarts (required because systemd can't be controlled from chroot)

3. **Role Execution Pattern** - Roles run in chroot mode but delegate service restarts to `local-host` using SSH

### Ansible Structure

Roles are applied in this order (see `ansible/bootstrap-server.yaml` or `ansible/aspen-generic.yaml`):

1. **base** - Installs Python3 (required for Ansible modules to work)
2. **chrony** - Configures NTP time synchronization with NIST servers
3. **users** - Creates 'cowboy' user with passwordless sudo
4. **ssh** - Hardens SSH (key-only auth, disables passwords), adds authorized keys
5. **nomad** - Installs HashiCorp Nomad from official repository

### Chroot vs SSH Delegation

Most tasks run via chroot connection, but service management (systemctl) requires SSH delegation because systemd cannot be controlled from within a chroot. This is why handlers in roles use `delegate_to: local-host`.

Example pattern in `ansible/roles/ssh/handlers/main.yaml`:
```yaml
- name: Restart SSH
  ansible.builtin.service:
    name: ssh
    state: restarted
  delegate_to: local-host  # Must use SSH, not chroot
```

## Development Commands

### Building the Ansible Docker Image

```bash
docker build -t cowboy-bootstrap-ansible ansible/
```

### Running Ansible Playbook Manually

```bash
docker run --rm -it \
    --privileged \
    --network host \
    -v /:/host \
    -v ~/.ssh/id_ed25519_ansible:/root/.ssh/id_ed25519:ro \
    cowboy-bootstrap-ansible \
    -i /ansible/inventories/bootstrap-server/hosts \
    -c community.general.chroot \
    -D /ansible/bootstrap-server.yaml
```

### Testing Individual Roles

To test a single role, modify the appropriate playbook (`ansible/bootstrap-server.yaml` or `ansible/aspen-generic.yaml`) to comment out other roles, then re-run.

### Debugging Ansible in Docker

Add `-vvv` for verbose output:

```bash
docker run --rm -it \
    --privileged \
    --network host \
    -v /:/host \
    -v ~/.ssh/id_ed25519_ansible:/root/.ssh/id_ed25519:ro \
    cowboy-bootstrap-ansible \
    -i /ansible/inventories/bootstrap-server/hosts \
    -c community.general.chroot \
    -D -vvv /ansible/bootstrap-server.yaml
```

## Key Configuration Notes

### SSH Configuration

The 'cowboy' user is authorized via hardcoded SSH key in `ansible/roles/ssh/tasks/main.yaml:16`. When modifying SSH access, update the key list in that file.

### Inventory Hosts

Two inventory hosts are defined:
- `local-chroot` - Target for chroot-based configuration
- `local-host` - Target for SSH-based service management (127.0.0.1)

Both connect to the same physical machine but via different mechanisms.

### Service Handlers

Service restart handlers must use `delegate_to: local-host` because systemd cannot be managed from chroot. The SSH connection is authenticated using the key generated by `begin.sh`.
- Planning of the project and next steps are tracked in PLAN.md
- always pin versions of container images
- when commenting in files try to write comments that don't break when settings change
- when comparing to M. Aldridge's Matrix repo, clone it to a tmp directory and scan the repo for reference